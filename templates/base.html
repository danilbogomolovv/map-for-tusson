<!DOCTYPE html>
{% load static %}
<html>
    <head>
        <title>Tusson</title>
        <meta charset="utf-8">
        <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
        <script src="https://unpkg.com/@google/markerclustererplus@4.0.1/dist/markerclustererplus.min.js"></script>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4" crossorigin="anonymous"></script>
        <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
        <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
        <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
        <script src="/static/js/script.js"></script>
        <link rel="stylesheet" href="/static/css/style.css">
    </head>

    <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark" style="z-index: 4">
      <div class="container-fluid">
        <a class="navbar-brand" href="/">Tusson</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavDarkDropdown" aria-controls="navbarNavDarkDropdown" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        {% block nav %}
        {% endblock nav %}
            <div class="navbar-text" style="width: 260px; text-align: center;">
                Всего терминалов : {{ count_all_terminals }} 
            </div>
           <!--  <a class="btn btn-outline-success" href="save/" role="button">Сохранить</a> -->
      </div>
    </nav>

    {% block content %}

    {% endblock content %}

    {% if display == 'none' %}
    <div class="search_info" style="display: none;">
    {% endif %}
    {% if display == 'block' %}
    <div class="search_info" style="display: block; background: #212529; color: #9e9e9e; height: 95%; width: 23%;">
    {% endif %}

        {% block clearbutton %}  {% endblock clearbutton %}

        <h5>Количество найденных терминалов : {{ count_search_terminals }}</h5>

        {% if search_terminal_names != None %}
            <div class="search_name">
                <h5>Инормация о названиях найденных терминалов:</h5>
                <ul>
                    {% for key, value in search_terminal_names %}
                        <li>{{ key }} : {{ value }}</li>
                    {% endfor %}
                </ul>
            </div>
        {% endif %}
        {% if search_terminal_parts != None %}
            <div class="search_parta">
                <h5>Информация о партнерах найденных терминалов:</h5>
                <ul>
                    {% for key, value in search_terminal_parts %}
                        <li>{{ key }} : {{ value }}</li>
                    {% endfor %}
                </ul>
            </div>
        {% endif %}
        {% if search_terminal_zones != None %}
            <div class="search_zone">
                <h5>Информация о зонах найденных терминалов:</h5>
                <ul>
                    {% for key, value in search_terminal_zones %}
                        <li>{{ key }} : {{ value }}</li>
                    {% endfor %}
                </ul>
            </div>
        {% endif %}
    </div>


    <div class="latlng_for_delete" style="display: none">
        <input type="" name="" id="lat_del_inp" >
        <input type="" name="" id="lng_del_inp" >
    </div>

    <div class="latlng_for_add_new_terminals" style="display: none;">
        <input type="" name="" id="lat_add_inp" >
        <input type="" name="" id="lng_add_inp" >
    </div>

    <div class="grey_bg" id="grey_bg" style="position: absolute; z-index: 5; background: grey; opacity: .3; width: 100%; height: 100%; display: none"></div>

    <div class="delete_marker" id="check_for_delete_marker" style="display:none; z-index: 6; position: absolute;
     text-align: center; top: 50%; left: 30%; background: white; border-radius: 5px; box-shadow: 0 0 10px rgba(0,0,0,0.5);">
      <h3 style="margin: 10px;">Вы уверены что хотите удалить этот маркер?</h3>
      <button style="float: left;margin: 10px" type="button" class="btn btn-outline-danger" onclick="delete_marker(document.getElementById('lat_del_inp').value,document.getElementById('lng_del_inp').value)">Удалить</button>
      <button style="float: right;margin: 10px" type="button" class="btn btn-outline-success" onclick="close_check_delete_marker()">Отмена</button>
    </div>


    <div class="add_terminal_to_marker" id="add_terminal_to_marker" style="display:none; z-index: 6; position: absolute;
     text-align: center; top: 50%; left: 20%; background: white; border-radius: 5px; box-shadow: 0 0 10px rgba(0,0,0,0.5);">
      <h3 style="margin: 10px;">Введите тид(ы) оборудования, которые вы хотите добавить в данный маркер</h3>
      <i>Если вводите несколько тидов делайте это через запятую</i> <br>
      <input type="text" name="" style="width: 70%" id="terminals_for_transfer">
      <button style="float: left;margin: 10px" type="button" class="btn btn-outline-success" onclick="add_terminal_to_marker(document.getElementById('lat_add_inp').value, document.getElementById('lng_add_inp').value)">Добавить</button>
      <button style="float: right;margin: 10px" type="button" class="btn btn-outline-danger" onclick="close_add_terminal_to_marker()">Закрыть</button>
    </div>

    <div class="search_place" style="z-index: 3;position: absolute;display:block; top: 10%; right: 4%;">
        <input type="text" name="" style="width: 100%" id="search_place">
        <button class="btn btn-success" style="float: right" onclick="search_place()">Поиск</button>
    </div>

  {% block map %}
    <div id="map" style="z-index: 1;">

    </div>
  {% endblock map %}



<!--     <div>
        {% for marker in markers %}
        {{ marker.count }}
        {% for term in marker.terminals.all %}
        {{ term.cadres }}
        {% endfor %}
        <p>----------------------------</p>
        {% endfor %}
    </div> -->

    <script type="text/javascript">

        

        let map;
        var js_markers = [];
        var coordinate_check_dict = {};

        {% block available %}



        {% endblock available %}

        function initMap() {

            {% block initcenter %}
            if (localStorage.getItem('zoom_level') == null || localStorage.getItem('center_lat') == null || localStorage.getItem('center_lng') == null) {

                map = new google.maps.Map(document.getElementById("map"), {

                center: { lat: 53.904789501846196, lng: 27.553534868069242 },
                zoom: 6,
                });

            } else {
                    map = new google.maps.Map(document.getElementById("map"), {

                    center: { lat: parseFloat(localStorage.getItem('center_lat')), lng: parseFloat(localStorage.getItem('center_lng')) },
                    zoom: parseInt(localStorage.getItem('zoom_level')),
                    });
            }
            
            {% endblock initcenter %}
        

            {% block script %}

            {% endblock script %}

/*            {% for i in terminals %}
                    {% if i.cstatus == 0 %}
                    //var terminal_marker = 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png'
                    var terminal_marker = '/static/image/terminal.png'
                    {% endif %}
                    {% if i.cstatus == 3 %}
                    //var terminal_marker = 'http://maps.google.com/mapfiles/ms/icons/red-dot.png'
                    var terminal_marker = '/static/image/repair.png'
                    {% endif %}

                    var check_lat = '{{i.lat}}';
                    var check_lng = '{{i.lng}}';
                    var check = true;
                    for (const [key, value] of Object.entries(coordinate_check_dict)) {
                          if (key == check_lat && value == check_lng) {
                            check = false;
                          }
                    }
                    
                    if (check) {
                        
                        var infoWindow = new google.maps.InfoWindow();
                        var marker = new google.maps.Marker({
                            map : map,
                            position : {lat: parseFloat('{{ i.lat }}'), lng: parseFloat('{{ i.lng }}')},
                            title : '{{ i.ddatap }}, {{ i.zona_name }}',
                            optimized: true,
                            
                            icon: terminal_marker

                        });
                        markers.push(marker);
                        
                        coordinate_check_dict[marker.getPosition().lat()] = marker.getPosition().lng();

                        var infolist = [];

                        {% for j in terminals_for_info %}

                            {% if i.lat == j.lat and i.lng == j.lng %}
                                {% if j.cstatus == 3 %}
                                infolist.push(" <p> " + "<h6>{{ j.ctid }}</h6>" + " </p> " + "{{ j.cname }}" + "<br>" + "{{j.cparta}}" + "<br>" + "{{j.cadres}}" + "<br>" + "<h6>Проблема : </h6>{{j.cmemo}}" + "<h6>Дата план: </h6>{{j.ddatap}}" + "<br> _________________________________");
                                {% else %}
                                infolist.push(" <p> " + "<h6>{{ j.ctid }}</h6>" + " </p> " + "{{ j.cname }}"+ "<br>" + "{{j.cparta}}"  + "<br>" + "{{j.cadres}}" + "<br> _________________________________");
                                {% endif %}
                            {% endif %}

                        {% endfor %}

                        var countterminals = infolist.length;

                        (function (marker, infolist, countterminals) {
                            google.maps.event.addListener(marker, "click", function (e) {
                                infoWindow.setContent("<div style = 'width:250px;min-height:60px'>" + 
                                    ' Количество оборудования: ' + countterminals + '<br> ' + 
                                    '_________________________________' + 
                                    infolist.join(' ') +
                                    "</div>");
                                infoWindow.open(map, marker);
                            });
                            })(marker, infolist, countterminals);
                    }

            {% endfor %}*/
            {% for office in offices %}
                var office_infolist = []
                var office_infoWindow = new google.maps.InfoWindow();
                var office_marker = new google.maps.Marker({
                        map : map,
                        position : {lat: parseFloat('{{ office.lat }}'), lng: parseFloat('{{ office.lng }}')},
                        //title : '{{ i.ddatap }}, {{ i.zona_name }}',
                        optimized: true,   
                        //label: 'ITC',

                        //icon: '/static/image/factory3.png'
                    }); 

                office_infolist.push(" <p> " + "<h6>{{ office.podr_name }}</h6>" + " </p> " + "{{ office.cadres }}" + "<br>" + "{{office.cfio}}"  + "<br> _________________________________");

               (function (office_marker, office_infolist) {
                            google.maps.event.addListener(office_marker, "click", function (e) {
                                infoWindow.setContent("<div style = 'width:250px;min-height:60px'>" + 
                                    office_infolist.join(' ') + 
                                    "</div>");
                                infoWindow.open(map, office_marker);
                            });
                            })(office_marker, office_infolist);
            {% endfor %}

            {% for i in mark %}
                    {% if i.status == 0 %}
                    var terminal_marker = '/static/image/terminal.png'
                    {% endif %}
                    {% if i.status == 3 %}
                    var terminal_marker = '/static/image/repair.png'
                    {% endif %}
                    {% if i.status == 2 %}
                    var terminal_marker = '/static/image/installation.png'
                    {% endif %}
                    var infoWindow = new google.maps.InfoWindow();
                    var marker = new google.maps.Marker({
                        map : map,
                        position : {lat: parseFloat('{{ i.lat }}'), lng: parseFloat('{{ i.lng }}')},
                        //title : '{{ i.ddatap }}, {{ i.zona_name }}',
                        optimized: true,         
                        icon: terminal_marker
                    });
                    js_markers.push(marker);


                    var infolist = [];
                    var tids_for_copy = [];
                    {% for j in i.terminals.all %}
                            tids_for_copy.push("{{ j.ctid }}")
                            {% if j.cstatus == 3 %}
                            infolist.push(" <p> " + "<h6>{{ j.ctid }}</h6>" + " </p> " + "{{ j.cname }}" + "<br>" + "{{j.cparta}}" + "<br>" + "{{j.cadres}}" + "<br>" + "<h6>Проблема : </h6>{{j.cmemo}}" + "<h6>Дата план: </h6>{{j.ddatap}}" + "<br> _________________________________");
                            {% elif j.cstatus == 2 %}
                            infolist.push(" <p> " + "<h6>{{ j.ctid }}</h6>" + " </p> " + "{{ j.cname }}" + "<br>" + "{{j.cparta}}" + "<br>" + "{{j.cadres}}" + "<br>" + "<h6>Информация : </h6>{{j.cmemo}}" + "<h6>Дата план: </h6>{{j.ddatap}}" + "<br> _________________________________");
                            {% else %}
                            infolist.push(" <p> " + "<h6>{{ j.ctid }}</h6>" + " </p> " + "{{ j.cname }}"+ "<br>" + "{{j.cparta}}"  + "<br>" + "{{j.cadres}}" + "<br> _________________________________");
                            {% endif %}
                    {% endfor %}

                    
                    
                  (function (marker, infolist, tids_for_copy) {
                            var tids_for_copy_str = tids_for_copy.toString()
                            
                            google.maps.event.addListener(marker, "click", function (e) {
                                infoWindow.setContent("<div style = 'width:250px;min-height:60px'>" + 
                                    ' <h6>Количество оборудования: ' + '{{i.count}} </h6>' + '<button type="button" class="btn btn-danger btn-sm" onclick="check_delete_marker('+ '{{i.lat}}' + ','+ '{{i.lng}}' +')" style="margin:5px;">Удалить</button><button type="button" style="margin:5px;" class="btn btn-success btn-sm" onclick="open_add_terminal_to_marker('+ '{{i.lat}}' + ','+ '{{i.lng}}' +')">Добавить</button></button><button type="button" style="margin:5px;" class="btn btn-primary btn-sm" onclick="copy_tids(' + '\''+ tids_for_copy_str +'\'' + ')">Копировать все тиды</button><br> ' + 
                                    '_________________________________' + 
                                    infolist.join(' ') + 
                                    "</div>");
                                infoWindow.open(map, marker);
                            });
                            })(marker, infolist, tids_for_copy);
                    
            {% endfor %}

                  map.addListener("rightclick", (mapsMouseEvent) => {
                    console.log(mapsMouseEvent.latLng)
                    infoWindow.close();

                    var latlng = JSON.stringify(mapsMouseEvent.latLng.toJSON(), null, 2)
                    var contentString = '<br> <div style="text-align: center">     <h3 style="margin: 10px;">Введите тид(ы) оборудования, кторое вы хотите добавить в данный маркер</h3> <i>Если вводите несколько тидов делайте это через запятую</i> <br><input type="text" name="" style="width: 70%" id="terminals_for_add"></div><br><button style="float:left" class="btn btn-outline-success" onclick="add_new_marker(\'' + mapsMouseEvent.latLng + '\')" >Создать маркер</button><button style="float:right" class="btn btn-outline-danger" onclick="infoWindow.close()">Закрыть</button>'
                    infoWindow = new google.maps.InfoWindow({
                      position: mapsMouseEvent.latLng,
                    });
                    infoWindow.setContent(
                      //SON.stringify(mapsMouseEvent.latLng.toJSON(), null, 2) +
                      contentString
                    );
                    infoWindow.open(map);
                  });

                  map.addListener("zoom_changed", (zoomEvent) => {
                    localStorage.setItem('zoom_level', map.getZoom());
                  })

                 map.addListener("center_changed", (CenterEvent) => {
                    localStorage.setItem('center_lat', map.getCenter().lat());
                    localStorage.setItem('center_lng', map.getCenter().lng());
                  })

            new MarkerClusterer(map, js_markers, {
                gridSize: 20,
                imagePath: "https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m",

              });
        }


    </script>
    <script    
        src=" https://maps.googleapis.com/maps/api/js?key={{google_api_key}}&callback=initMap&libraries=&v=weekly" async
    ></script>



 </body>

</html>

{% block style %}
{% endblock %}