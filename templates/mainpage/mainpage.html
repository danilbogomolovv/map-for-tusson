<!DOCTYPE html>
<html>
    <head>
        <title>Tusson</title>
        <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
        <script src="https://unpkg.com/@google/markerclustererplus@4.0.1/dist/markerclustererplus.min.js"></script>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4" crossorigin="anonymous"></script>
    </head>

    <body>
        {{ count_search_terminals }}
        {% if display == 'none' %}
        <div class="test" style="display: none;">
        {% endif %}
        {% if display == 'block' %}
        <div class="test" style="display: block;'">
        {% endif %}
            <p>test</p>

        </div>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark" style="z-index: 4">
      <div class="container-fluid">
        <a class="navbar-brand" href="/">Tusson</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavDarkDropdown" aria-controls="navbarNavDarkDropdown" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarNavDarkDropdown" style="width: 0px;">
          <ul class="navbar-nav">
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" id="navbarDarkDropdownMenuLink" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                Название терминала
              </a>
              <ul class="dropdown-menu dropdown-menu-dark" aria-labelledby="navbarDarkDropdownMenuLink">
                {% for key, value in terminal_names %}
                    <li><a class="dropdown-item" href="javascript:addParam('{{ key }}', '','');">{{ key }} : {{ value }}</a></li>
                {% endfor %}
              </ul>
            </li>
          </ul>
          <ul class="navbar-nav">
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" id="navbarDarkDropdownMenuLink" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                Название партнера
              </a>
              <ul class="dropdown-menu dropdown-menu-dark" aria-labelledby="navbarDarkDropdownMenuLink">
                {% for key, value in terminal_parts %}
                    <li><a class="dropdown-item" href="javascript:addParam('','{{key}}','');">{{ key }} : {{ value }}</a></li>
                {% endfor %}
              </ul>
            </li>
          </ul>
          <ul class="navbar-nav">
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" id="navbarDarkDropdownMenuLink" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                Название зоны
              </a>
              <ul class="dropdown-menu dropdown-menu-dark" aria-labelledby="navbarDarkDropdownMenuLink">
                {% for key, value in terminal_zones %}
                    <li><a class="dropdown-item" href="javascript:addParam('','','{{key}}');">{{ key }} : {{ value }}</a></li>
                {% endfor %}
              </ul>
            </li>
          </ul>
        </div>
 


        {% if search_name != "" or search_parta != "" or search_zone != "" %}
            <a class="btn btn-outline-danger" href="javascript:clearHref();" role="button">Сбросить </a>
        {% endif %}
            <a class="btn btn-outline-success" href="save/" role="button">Сохранить</a>
      </div>
    </nav>

    <div id="map" style="z-index: 0"></div>

    <script type="text/javascript">
        let map;
        var markers = [];
        function initMap() {
            map = new google.maps.Map(document.getElementById("map"), {
            center: { lat: 53.904789501846196, lng: 27.553534868069242 },
            zoom: 6,
        });

            {% for i in terminals %}

               // {% if i.lat != 'exist' and i.lng != 'exist' %}

                    var infoWindow = new google.maps.InfoWindow();
                    var marker = new google.maps.Marker({
                        map : map,
                        position : {lat: parseFloat('{{ i.lat }}'), lng: parseFloat('{{ i.lng }}')},
                        title : '{{ i.cparta }}, {{ i.zona_name }}'
                    });
                    markers.push(marker);

                    var infolist = ["<p> " + "{{ i.ctid }}" + " </p> " + "{{ i.cname }}" + "<br> _________________________________"];
                    var cadres = "{{ i.cadres }}";

                    {% for j in existterminals %}

                        {% if i.lat == j.lat and i.lng == j.lng %}
                            infolist.push(" <p> " + "{{ j.ctid }}" + " </p> " + "{{j.cadres}}" + "<br>" + "{{ j.cname }}" + "<br> _________________________________");
                        {% endif %}

                    {% endfor %}

                    var countterminals = infolist.length;

                    (function (marker, cadres, infolist, countterminals) {
                        google.maps.event.addListener(marker, "click", function (e) {
                            infoWindow.setContent("<div style = 'width:250px;min-height:60px'>" + 
                                '<p> Количество териналов: ' + countterminals + '</p> ' + 
                                cadres + '<br> _________________________________' + 
                                infolist.join(' ') +
                                "</div>");
                            infoWindow.open(map, marker);
                        });
                        })(marker, cadres, infolist, countterminals);
                        
             //   {% endif %}

            {% endfor %}

            new MarkerClusterer(map, markers, {
                gridSize: 25,
                imagePath: "https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m",
              });

            //alert(markers.length);
        }



        function addParam(name, parta, zone) {
             if (name != '') {
                localStorage.setItem('name', name);
            };
             if (parta != '') {
                localStorage.setItem('parta', parta);
            };
            if (zone != '') {
                localStorage.setItem('zone', zone);
            };
             
            let href_name = localStorage.getItem('name');
            let href_parta = localStorage.getItem('parta');
            let href_zone = localStorage.getItem('zone');
            window.location.href = '/search/?name=' + href_name + '&parta=' + href_parta + '&zone=' + href_zone;

/*             if (href_parta == '' && href_name != '' && href_zone == '')  {
                window.location.href = '/search/?name=' + href_name;
            };

            if (href_name == '' && href_parta != '' && href_zone == '') {
                window.location.href = '/search/?parta=' + href_parta;
            };

            if (href_name == '' && href_parta == '' && href_zone != '') {
                window.location.href = '/search/?zone=' + href_parta;
            };  

            if (href_parta != '' && href_name != '') {
                window.location.href = '/search/?name=' + href_name + '&parta=' + href_parta;
            };*/




/*            if (href_name != '')  {
                if (window.location.href.match(/name\=([a-z0-9%]+)/i) != null) {
                        var delparam = window.location.href.match(/name\=([a-z0-9%]+)/i) + '';
                        delparam = delparam.split(',')[0];
                        alert(delparam)
                        window.location.replace(delparam);
                    }
                
                if (window.location.href.includes('?')){
                    window.location.href = window.location.href + '&name=' + href_name;
                } else {
                    window.location.href = window.location.href + 'search/?name=' + href_name;
                }
            };

            if (href_parta != '') {
                if(window.location.href.includes('?')){
                    window.location.href = window.location.href + '&parta=' + href_parta;
                } else {
                    window.location.href = window.location.href + 'search/?parta=' + href_parta;
                }
            };
           
            if (href_zone != '') {
                if(window.location.href.includes('?')){
                    window.location.href = window.location.href + '&zone=' + href_zone;
                } else {
                    window.location.href = window.location.href + 'search/?zone=' + href_zone;
                }
            };*/
        }

        function clearHref(){
            localStorage.setItem('parta', '');
            localStorage.setItem('name', '');
            localStorage.setItem('zone', '');
            window.location.href = '/';
        }



    </script>

    <script
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC_CpD9oSCYYDu92Jq8EiIGklCgyelDbiw&callback=initMap&libraries=&v=weekly"
        async
    ></script>

    </body>
</html>

<style type="text/css">
    #map {
    height: 94%;
    
    }

    html,
    body {
    height: 100%;
    margin: 0;
    padding: 0;
    }

    .dropdown-menu { overflow-y: scroll; max-height: 350px; }
</style>