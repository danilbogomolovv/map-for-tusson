<!DOCTYPE html>
{% load static %}
<html>
    <head>
        <title>Tusson</title>
        <meta charset="utf-8">
        <meta name=viewport content="width=device-width, initial-scale=1">
        <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
        <script src="https://unpkg.com/@google/markerclustererplus@4.0.1/dist/markerclustererplus.min.js"></script>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4" crossorigin="anonymous"></script>
        <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
        <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
        <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
        <script src="/static/js/script.js"></script>
        <link rel="stylesheet" href="/static/css/style.css">
    </head>

    <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark" style="z-index: 4">
      <div class="container-fluid">
        <a class="navbar-brand" href="/">Tusson</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavDarkDropdown" aria-controls="navbarNavDarkDropdown" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
            {% block nav %}
                <a class="btn btn-outline-danger" href="/" role="button">Все терминалы</a>
            {% endblock nav %}
            <div class="navbar-text" style="width: 260px; text-align: center;">
                Всего терминалов : {{ count_all_terminals }} 
            </div>
      </div>
    </nav>
<div class="filterform" id="filterform" style="display: block; background: #212529; color: #9e9e9e; height: 95%; overflow: auto; width: 23%;"> 
    <h5>Постройте маршрут</h5>
    <table>
          <tr>
              <td>Пункт отправки:</td>
              </tr>
              <tr>

              <td><input type="text" size="25" class="form-control" name="first_input" id="point_of_departure" placeholder="Введите пункт отправки" onchange="addParam('',document.getElementById('point_of_departure').value,'', false)"></td>
          </tr> 
          <tr>
              <td>Пункт прибытия:</td>
          </tr>
          <tr>
              <td><input type="text" id="point_of_arrival" size="25" class="form-control" name="last_input" placeholder="Введите пункт прибытия" onchange="addParam('',document.getElementById('point_of_departure').value,'', false)"></td>
          </tr>
          <tr>
              <td>Промежуточные тиды(через запятую):</td>
        
          </tr>
          <tr>
              <td><input type="text" size="40" class="form-control" name="waypoints_input" placeholder="Введите промежуточные тиды"></td>
          </tr>
          <tr>
              <td>Время отправки</td>
          </tr>
          <tr>
              <td><input type="text" size="40" class="form-control" name="time_of_departure_input" placeholder="Введите время отправки"></td>
          </tr>
    </table>
    <a class="btn btn-outline-primary" id="filter_button" role="button" onclick="addRouteParam()">Построить маршрут</a>

    <div class="route_info" id="route_info" style="display: none; width: 100%">
        <h5 id="full_distance">Расстояние: </h5>
        <h5 id="full_time">Примерное время в пути: <span id="full_time_int"></span></h5>
        <div class="vl" style="z-index: 1" id="line"></div>

    </div>
</div>


    <div id="map" style="z-index: 0"></div>

    <script type="text/javascript">

        localStorage.setItem('startpoint', '{{start_py}}')
        localStorage.setItem('tids', '{{tids_py}}')
        localStorage.setItem('endpoint', '{{end_py}}')
        localStorage.setItem('time_of_departure', '{{time_of_departure_py}}')

        try {
       
        var availablepoints = '{{ availablepoints }}'.replace(/\[&#x27;/g,'')
        
        availablepoints = availablepoints.split('&#x27;, &#x27;')
        
        } catch {
            console.log('error availablepoints')
        }

        $( "#point_of_departure" ).autocomplete({
          source: availablepoints
        });

        $( "#point_of_arrival" ).autocomplete({
          source: availablepoints
        });
        
        let map;
        var js_markers = [];
        var coordinate_check_dict = {};
        const waypts = [];

        {% for i in waypoints %}

          waypts.push({
            location: '{{i.lat}},{{i.lng}}',
            stopover: true,
          });

        {% endfor %}


        function initMap() {
            var directionsService = new google.maps.DirectionsService();
            var directionsRenderer = new google.maps.DirectionsRenderer();
        
            map = new google.maps.Map(document.getElementById("map"), {
            center: { lat: 53.904789501846196, lng: 27.553534868069242 },
            zoom: 6,
        });
            directionsRenderer.setMap(map);

           {% if check %}
            calculateAndDisplayRoute(directionsService, directionsRenderer);
            {% endif %}

            {% for i in mark %}
                    {% if i.status == 0 %}
                    var terminal_marker = '/static/image/terminal.png'
                    {% endif %}
                    {% if i.status == 3 %}
                    var terminal_marker = '/static/image/repair.png'
                    {% endif %}
                    {% if i.status == 2 %}
                    var terminal_marker = '/static/image/installation.png'
                    {% endif %}
                    var infoWindow = new google.maps.InfoWindow();
                    var marker = new google.maps.Marker({
                        map : map,
                        position : {lat: parseFloat('{{ i.lat }}'), lng: parseFloat('{{ i.lng }}')},
                        optimized: true,         
                        icon: terminal_marker
                    });
                    js_markers.push(marker);


                    var infolist = [];
                    {% for j in i.terminals.all %}
                            {% if j.cstatus == 3 %}
                            infolist.push(" <p> " + "<h6>{{ j.ctid }}</h6>" + " </p> " + "{{ j.cname }}" + "<br>" + "{{j.cparta}}" + "<br>" + "{{j.cadres}}" + "<br>" + "<h6>Проблема : </h6>{{j.cmemo}}" + "<h6>Дата план: </h6>{{j.ddatap}}" + "<br> _________________________________");
                            {% else %}
                            infolist.push(" <p> " + "<h6>{{ j.ctid }}</h6>" + " </p> " + "{{ j.cname }}"+ "<br>" + "{{j.cparta}}"  + "<br>" + "{{j.cadres}}" + "<br> _________________________________");
                            {% endif %}
                    {% endfor %}

                  (function (marker, infolist) {
                            google.maps.event.addListener(marker, "click", function (e) {
                                infoWindow.setContent("<div style = 'width:250px;min-height:60px'>" + 
                                    ' Количество оборудования: ' + '{{i.count}}' + '<br> ' + 
                                    '_________________________________' + 
                                    infolist.join(' ') +
                                    "</div>");
                                infoWindow.open(map, marker);
                            });
                            })(marker, infolist);
                    
            {% endfor %}


            new MarkerClusterer(map, js_markers, {
                gridSize: 20,
                imagePath: "https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m",

              });
        }

function calculateAndDisplayRoute(directionsService, directionsRenderer) {
  var full_distance = 0
  var full_time = 0
  var line_length = 0
  var additional_time = -12
  var waypts_addresses = []
  waypts_addresses.push('{{first}}')
  directionsService
    .route({
      origin: {
        query: '{{first}}',
      },
      destination: {
        query: '{{last}}',
      },
      waypoints: waypts,
      optimizeWaypoints: true,
      travelMode: google.maps.TravelMode.DRIVING,
    })
    .then((response) => {
      document.getElementById('route_info').style.display = 'block'
      directionsRenderer.setDirections(response);
      console.log(response['routes']);
      for (var i = 0; i < response['routes']['0']['legs'].length; i++) {
          additional_time = additional_time + 12
          var num = i + 1 
          line_length = line_length + 185
          waypts_addresses.push(response['routes']['0']['legs'][i]['end_address'])
          full_distance = full_distance + response['routes']['0']['legs'][i]['distance']['value']
          full_time = full_time + response['routes']['0']['legs'][i]['duration']['value']
          document.getElementById('route_info').innerHTML += '<div class="circle" style="z-index:6"><h6 style="text-align: center; z-index:7; position: relative;">'  + num + '</h6></div><p>' + waypts_addresses[i] + '<p>' + '<p class="waypts_dist_and_durat">' + response['routes']['0']['legs'][i]['distance']['text'] + '<br>' + response['routes']['0']['legs'][i]['duration']['text'] + '<br>' + '</p>'; 
      }
      document.getElementById('route_info').innerHTML += '<div class="circle"><h6 style="text-align: center; z-index:7; position: relative;">'  + parseInt(num+1,10) + '</h6></div><p>' + '{{last}}' + '<p>'
      document.getElementById('full_distance').innerHTML += full_distance/1000 + ' км.'

      if (Math.floor(full_time/60 + additional_time) < 60) {

        document.getElementById('full_time_int').innerHTML += Math.floor(full_time/60 + additional_time) + ' мин.' + '<br>_______________________________________'    

      } else {

        document.getElementById('full_time_int').innerHTML += Math.floor((full_time/60 + additional_time)/60) + ' ч. ' + Math.floor((full_time/60 + additional_time)%60) + 'мин. <br>_______________________________________'  

      }

      document.getElementById('line').style.height = line_length + 'px';
    })
    .catch((e) => window.alert("Directions request failed due to " + status));
}


    </script>
    <script    
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBfn_P6QEZBPg_63eVldoKmG7PbzZnGMdo&callback=initMap&libraries=&v=weekly" async
    ></script>



 </body>

</html>